{"version":3,"file":"next-api-og-image.umd.js","sources":["../src/index.ts"],"sourcesContent":["import type { NextApiRequest, NextApiResponse } from 'next'\nimport type { Except, RequireExactlyOne } from 'type-fest'\nimport type { Page, Viewport } from 'puppeteer-core'\nimport type { ReactElement } from 'react'\nimport { renderToStaticMarkup } from 'react-dom/server'\nimport deepMerge from 'deepmerge'\nimport twemoji from 'twemoji'\nimport core from 'puppeteer-core'\nimport chrome from 'chrome-aws-lambda'\n\nconst STRATEGY_OPTIONS = ['body', 'query'] as const\ntype StrategyOption = typeof STRATEGY_OPTIONS[number]\n\nconst ENV_MODES = ['development', 'staging', 'production', 'testing'] as const\ntype EnvMode = typeof ENV_MODES[number]\n\ntype ImageType = 'png' | 'jpeg' | 'webp'\n\ntype StrategyAwareParams<\n  T extends StrategyOption = 'query',\n  StrategyDetails extends string | object = string,\n> = T extends 'body'\n  ? StrategyDetails\n  : Record<StrategyDetails extends string ? StrategyDetails : string, NonNullable<string>>\n\nexport type NextApiOgImageConfig<\n  Strategy extends StrategyOption,\n  StrategyDetails extends string | object = string,\n> = {\n  template: RequireExactlyOne<\n    Partial<{\n      html: (params: StrategyAwareParams<Strategy, StrategyDetails>) => string | Promise<string>\n      react: (params: StrategyAwareParams<Strategy, StrategyDetails>) => ReactElement | Promise<ReactElement>\n    }>,\n    'html' | 'react'\n  >\n  strategy?: StrategyOption\n  contentType?: string\n  cacheControl?: string\n  width?: number\n  height?: number\n  type?: ImageType\n  quality?: number\n  dev?: Partial<{\n    inspectHtml: boolean\n    errorsInResponse: boolean\n  }>\n}\n\ntype BrowserEnvironment = {\n  envMode: EnvMode\n  executable: string\n  page: Page\n  createImage: (html: string) => Promise<Buffer> | Promise<string>\n}\n\nexport function withOGImage<\n  Strategy extends StrategyOption = 'query',\n  StrategyDetails extends string | object = string,\n>(options: NextApiOgImageConfig<Strategy, StrategyDetails>) {\n  const defaultOptions: Except<NextApiOgImageConfig<Strategy, StrategyDetails>, 'template'> = {\n    contentType: options.type ? `image/${options.type}` : 'image/png',\n    strategy: 'query',\n    cacheControl: 'max-age 3600, must-revalidate',\n    width: 1200,\n    height: 630,\n    type: 'png',\n    quality: 90,\n    dev: {\n      inspectHtml: true,\n      errorsInResponse: true,\n    },\n  }\n\n  options = deepMerge(defaultOptions, options) as NextApiOgImageConfig<Strategy, StrategyDetails>\n\n  const {\n    template: { html: htmlTemplate, react: reactTemplate },\n    cacheControl,\n    strategy,\n    contentType,\n    width,\n    height,\n    type,\n    quality,\n    dev: { inspectHtml, errorsInResponse },\n  } = options\n\n  if (htmlTemplate && reactTemplate) {\n    throw new Error('Ambigious template provided. You must provide either `html` or `react` template.')\n  }\n\n  if (!htmlTemplate && !reactTemplate) {\n    throw new Error('No template was provided.')\n  }\n\n  const envMode = process.env.NODE_ENV as EnvMode\n\n  const createBrowserEnvironment = pipe(\n    getChromiumExecutable,\n    prepareWebPageFactory({ width, height }),\n    createImageFactory({ inspectHtml, type, quality }),\n  )\n\n  return async function (request: NextApiRequest, response: NextApiResponse) {\n    checkStrategy(strategy, !isProductionLikeMode(envMode) ? errorsInResponse : false, request, response)\n\n    const params = stringifyObjectProps(strategy === 'query' ? request.query : request.body)\n    const browserEnvironment = await createBrowserEnvironment()\n\n    const html =\n      htmlTemplate && !reactTemplate\n        ? await htmlTemplate({ ...params } as StrategyAwareParams<Strategy, StrategyDetails>)\n        : renderToStaticMarkup(\n            await reactTemplate({ ...params } as StrategyAwareParams<Strategy, StrategyDetails>),\n          )\n\n    response.setHeader(\n      'Content-Type',\n      !isProductionLikeMode(envMode) && inspectHtml ? 'text/html' : contentType,\n    )\n    response.setHeader('Cache-Control', cacheControl)\n\n    response.write(await browserEnvironment.createImage(emojify(html)))\n    response.end()\n  }\n}\n\nfunction isProductionLikeMode(envMode: EnvMode) {\n  return envMode === 'production' || envMode === 'staging'\n}\n\nfunction checkStrategy(\n  strategy: StrategyOption,\n  errorsInResponse: boolean,\n  request: NextApiRequest,\n  response: NextApiResponse,\n) {\n  const checks: Record<StrategyOption, () => void> = {\n    body: () => {\n      const {\n        method,\n        headers: { 'content-type': contentType },\n      } = request\n\n      if (method !== 'POST' && contentType !== 'application/json') {\n        const message = `Strategy is set to \\`body\\` so parameters must be passed by POST request and JSON payload. Current method: ${method} and current content type: ${contentType}`\n\n        if (errorsInResponse) {\n          response.json({ message })\n        }\n\n        throw new Error(message)\n      }\n    },\n    query: () => {\n      const { method } = request\n\n      if (method !== 'GET') {\n        const message = `Strategy is set to \\`query\\` so parameters must be passed by GET request and query params. Current method: ${method}`\n\n        if (errorsInResponse) {\n          response.json({ message })\n        }\n\n        throw new Error(message)\n      }\n    },\n  }\n  const currentCheck = checks[strategy]\n\n  if (!currentCheck) {\n    throw new Error(`Unknown strategy provided. Possible values: ${STRATEGY_OPTIONS}`)\n  }\n\n  currentCheck()\n}\n\nfunction stringifyObjectProps(object: object) {\n  return JSON.parse(\n    JSON.stringify(object, (key, value) => (value && typeof value === 'object' ? value : `${value}`)),\n  )\n}\n\nfunction emojify(html: string) {\n  const emojified = twemoji.parse(html, { folder: 'svg', ext: '.svg' })\n\n  const emojiStyle = `\n    .emoji {\n      height: 1em;\n      width: 1em;\n      margin: 0 .05em 0 .1em;\n      vertical-align: -0.1em;\n    }\n  `\n\n  return `<style>${emojiStyle}</style>${emojified}`\n}\n\nfunction pipe(...functions: Array<Function>): () => Promise<BrowserEnvironment> {\n  return async function () {\n    return await functions.reduce(\n      async (acc, fn) => await fn(await acc),\n      Promise.resolve({ envMode: process.env.NODE_ENV as EnvMode } as BrowserEnvironment),\n    )\n  }\n}\n\nfunction getChromiumExecutable(browserEnvironment: BrowserEnvironment) {\n  const executable =\n    process.platform === 'win32'\n      ? 'C:\\\\Program Files (x86)\\\\Google\\\\Chrome\\\\Application\\\\chrome.exe'\n      : process.platform === 'linux'\n      ? '/usr/bin/google-chrome'\n      : '/Applications/Google Chrome.app/Contents/MacOS/Google Chrome'\n\n  return { ...browserEnvironment, executable }\n}\n\nfunction prepareWebPageFactory(viewPort: Viewport) {\n  return async function (browserEnvironment: BrowserEnvironment) {\n    const { page, envMode, executable } = browserEnvironment\n\n    if (page) {\n      return { ...browserEnvironment, page }\n    }\n\n    const chromiumOptions = !isProductionLikeMode(envMode)\n      ? { args: [], executablePath: executable, headless: true }\n      : {\n          args: chrome.args,\n          executablePath: await chrome.executablePath,\n          headless: chrome.headless,\n        }\n\n    const browser = await core.launch(chromiumOptions)\n    const newPage = await browser.newPage()\n    await newPage.setViewport(viewPort)\n\n    return { ...browserEnvironment, page: newPage }\n  }\n}\n\nfunction createImageFactory({\n  inspectHtml,\n  type,\n  quality,\n}: {\n  inspectHtml: boolean\n  type: ImageType\n  quality: number\n}) {\n  return function (browserEnvironment: BrowserEnvironment) {\n    const { page, envMode } = browserEnvironment\n\n    return {\n      ...browserEnvironment,\n      createImage: async function (html: string) {\n        await page.setContent(html)\n        const file =\n          !isProductionLikeMode(envMode) && inspectHtml\n            ? await page.content()\n            : await page.screenshot({ type, encoding: 'binary', quality })\n        return file\n      },\n    }\n  }\n}\n"],"names":["STRATEGY_OPTIONS","isProductionLikeMode","envMode","getChromiumExecutable","browserEnvironment","executable","process","platform","options","deepMerge","contentType","type","strategy","cacheControl","width","height","quality","dev","inspectHtml","errorsInResponse","template","htmlTemplate","html","reactTemplate","react","Error","viewPort","env","NODE_ENV","createBrowserEnvironment","functions","reduce","acc","fn","Promise","resolve","pipe","core","launch","_isProductionLikeMode2","args","executablePath","headless","chrome","browser","newPage","setViewport","page","createImage","setContent","content","screenshot","encoding","createImageFactory","request","response","checks","body","method","headers","message","json","query","currentCheck","checkStrategy","params","JSON","parse","stringify","key","value","renderToStaticMarkup","setHeader","write","twemoji","folder","ext","emojify","_write","end"],"mappings":"ozBAUA,IAAMA,EAAmB,CAAC,OAAQ,SAsHlC,SAASC,EAAqBC,GAC5B,MAAmB,eAAZA,GAAwC,YAAZA,EA+ErC,SAASC,EAAsBC,GAQ7B,YAAYA,GAAoBC,WANT,UAArBC,QAAQC,SACJ,mEACqB,UAArBD,QAAQC,SACR,yBACA,wFA3JNC,GACA,OAcAA,EAAUC,UAdkF,CAC1FC,YAAaF,EAAQG,cAAgBH,EAAQG,KAAS,YACtDC,SAAU,QACVC,aAAc,gCACdC,MAAO,KACPC,OAAQ,IACRJ,KAAM,MACNK,QAAS,GACTC,IAAK,CACHC,aAAa,EACbC,kBAAkB,IAIcX,IAGlCY,SAAkBC,IAANC,KAA2BC,IAAPC,MAChCX,EAQEL,EARFK,aACAD,EAOEJ,EAPFI,SACAF,EAMEF,EANFE,YACAI,EAKEN,EALFM,MACAC,EAIEP,EAJFO,OACAJ,EAGEH,EAHFG,KACAK,EAEER,EAFFQ,UAEER,EADFS,IAAOC,IAAAA,YAAaC,IAAAA,iBAGtB,GAAIE,GAAgBE,EAClB,UAAUE,MAAM,oFAGlB,IAAKJ,IAAiBE,EACpB,UAAUE,MAAM,6BAGlB,IA2H6BC,EA3HvBxB,EAAUI,QAAQqB,IAAIC,SAEtBC,EAqGR,eAAiBC,2BACf,6CACeA,EAAUC,gBACdC,EAAKC,8BAAsBD,2CAATC,4CACzBC,QAAQC,QAAQ,CAAEjC,QAASI,QAAQqB,IAAIC,aAH3C,oCAtGiCQ,CAC/BjC,GAwH2BuB,EAvHL,CAAEZ,MAAAA,EAAOC,OAAAA,YAwHVX,gDAeCiC,UAAKC,OARHC,IAEpB,CACEC,OACAC,iBACAC,SAAUC,UAAOD,0BAGjBE,0BACgBA,EAAQC,yBAAxBA,0BACAA,EAAQC,YAAYpB,oBAE1B,YAAYtB,GAAoB2C,KAAMF,WAlB9BE,EAA8B3C,EAA9B2C,KAAM7C,EAAwBE,EAAxBF,QAASG,EAAeD,EAAfC,WAEvB,GAAI0C,EACF,4BAAY3C,GAAoB2C,KAAAA,YAGT9C,EAAqBC,QAGlCyC,UAAOH,gCAFf,CAAEA,KAAM,GAAIC,eAAgBpC,EAAYqC,UAAU,oBAG1BC,UAAOF,yBAXrC,qCAuBF,gBACEvB,IAAAA,YACAP,IAAAA,KACAK,IAAAA,QAMA,gBAAiBZ,GACf,IAAQ2C,EAAkB3C,EAAlB2C,KAAM7C,EAAYE,EAAZF,QAEd,YACKE,GACH4C,qBAA6B1B,8BACrByB,EAAKE,WAAW3B,4CAEnBrB,EAAqBC,IAAYgB,EACxB6B,EAAKG,UACLH,EAAKI,WAAW,CAAExC,KAAAA,EAAMyC,SAAU,SAAUpC,QAAAA,OAL/C,uCA5JbqC,CAAmB,CAAEnC,YAAAA,EAAaP,KAAAA,EAAMK,QAAAA,KAG1C,gBAAuBsC,EAAyBC,QA4BlD,SACE3C,EACAO,EACAmC,EACAC,GAEA,IAAMC,EAA6C,CACjDC,KAAM,WACJ,IACEC,EAEEJ,EAFFI,OAC2BhD,EACzB4C,EADFK,QAAW,gBAGb,GAAe,SAAXD,GAAqC,qBAAhBhD,EAAoC,CAC3D,IAAMkD,8GAAwHF,gCAAoChD,EAMlK,MAJIS,GACFoC,EAASM,KAAK,CAAED,QAAAA,QAGRnC,MAAMmC,KAGpBE,MAAO,WACL,IAAQJ,EAAWJ,EAAXI,OAER,GAAe,QAAXA,EAAkB,CACpB,IAAME,8GAAwHF,EAM9H,MAJIvC,GACFoC,EAASM,KAAK,CAAED,QAAAA,QAGRnC,MAAMmC,MAIhBG,EAAeP,EAAO5C,GAE5B,IAAKmD,EACH,UAAUtC,qDAAqDzB,GAGjE+D,IAtEEC,CAAcpD,GAAWX,EAAqBC,IAAWiB,EAA0BmC,EAASC,GAE5F,IAAMU,EAwEDC,KAAKC,MACVD,KAAKE,UAzE4C,UAAbxD,EAAuB0C,EAAQQ,MAAQR,EAAQG,KAyE5D,SAACY,EAAKC,UAAWA,GAA0B,iBAAVA,EAAqBA,KAAWA,4BAxEvDzC,mBAA3BzB,+BAEN,IAAMkB,EACJD,IAAiBE,IAEbgD,0BAINhB,EAASiB,UACP,gBACCvE,EAAqBC,IAAYgB,EAAc,YAAcR,GAEhE6C,EAASiB,UAAU,gBAAiB3D,SAEpC0C,EAASkB,6BAAYrE,EAAmB4C,YA6D5C,SAAiB1B,GAYf,sJAXkBoD,UAAQP,MAAM7C,EAAM,CAAEqD,OAAQ,MAAOC,IAAK,SA9DNC,CAAQvD,sBAA5DwD,OAAAvB,KACAA,EAASwB,eAbP1D,IAAiBE,IAAjBF,IAAiBE,IAGLA,OAAmB0C,qBAH/B5C,IAAiBE,IAGLA,OAAmB0C,oBAH/B5C,IAAiBE,kBAAjBF,IAAiBE,EACPF,OAAkB4C,iBAD5B5C,IAAiBE,EACPF,OAAkB4C,SARhC"}